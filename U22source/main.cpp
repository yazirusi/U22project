#include "DxLib.h"
#include "sounds.h"
#include "images.h"
#include "GameInit.h"
#include "map.h"
#include "notes.h"
#include "player.h"
#include "time.h"
#include "key.h"
#include "EnemyMove.h"
#include "EnemyAttck.h"
#include "PlayerAttack.h"
#include "BackgroundMove.h"
#include "main.h"
#include <time.h>
#include <stdio.h>
#include "GameTitle.h"
#include "GameOver.h"

/***********************************************
 * 関数のプロトタイプ宣言
 ***********************************************/

void DrawGameTitle(void);
void GameMain(void);		//ゲームメイン処理
void DrawGameOver(void);		//ゲームオーバー画面処理
void BossStage(void);		//ボスステージへの移動
void FpsTimeFanction(void);

int counter = 0, FpsTime[2] = { 0, }, FpsTime_i = 0;
double Fps = 0.0;

/***********************************************
 * プログラムの開始
 ***********************************************/
int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,
	LPSTR lpCmdLine, int nCmdShow) {
	SetMainWindowText("U22");
	ChangeWindowMode(TRUE);		// ウィンドウモードで起動
	//SetGraphMode(1280, 850, 32);
	SetGraphMode(1280, 850, 32, 600);

	if (DxLib_Init() == -1) return -1;	// DXライブラリの初期化処理

	SetDrawScreen(DX_SCREEN_BACK);	// 描画先画面を裏にする

	if (LoadImages() == -1)return -1;	//画像読み込み関数を呼び出

	if (LoadSounds() == -1)return -1;


	//時間の読み込み
	time_t jikan = time(NULL);
	struct tm imanojikan;

	errno_t error;

	error = localtime_s(&imanojikan, &jikan);

	//ファイルの読み込み
	FILE* fp;

	SaveData_t Data;

	fopen_s(&fp,"time.txt", "rb");
	if (fp == NULL) {
		return 0;
	}
	fread(&Data, sizeof(Data), 1, fp);
	fclose(fp);

	double dNextTime = GetNowCount();
	int RefreshTime = 0;

	// ゲームループ
	while (ProcessMessage() == 0 && g_GameState != 99 && !(g_KeyFlg & PAD_INPUT_START)) {

		key();

		/*//Qキーを押したら敵とプレイヤーが復活(デバッグ用)
		if (g_NowKey & PAD_INPUT_L) {
			player.hp = 100;
			Enemy.drawf = 1;
			for (int y = 0; y < MAPHEIGHT; y++) {
				for (int x = 0; x < MAPWIDTH; x++) {
					if (g_StageData[0][y][x] == 3) {
						Enemy.MapX = x;//敵のマップ上のｘ座標を入れる
						Enemy.MapY = y;//敵のマップ上のy座標を入れる
						Enemy.x = (x * 40);//敵の初期x座標
						Enemy.y = (y * 40);//敵の初期y座標
					}
				}
			}
		}*/

		ClearDrawScreen();		// 画面の初期化
		switch (g_GameState) {
		case 0 :
			DrawGameTitle();
			break;
		case 1:
			GameInit();         //初期化
			break;
		case 2:
			GameMain();			//ゲームメイン処理
			break;
		case 3:
			DrawGameOver();			//ゲームオーバー処理
			break;
		case 4:
			BossStage();
			break;
		}
		//最終更新日の表示
		SetFontSize(32);
		DrawFormatString(50, 5, 0x000000, "更新日時　%d月 %d日 %d時　%d分", Data.month, Data.day, Data.hour, Data.min);
		DrawFormatString(1000, 5, 0x000000, "ESC:終了");
		SetFontSize(16);

		//RefreshTime = GetNowCount();            //今の時間を取得

		FpsTimeFanction();	//フレームレート表示

		counter++;
		while (GetNowCount() - RefreshTime < 17);//1周の処理が17ミリ秒になるまで待つ

		ScreenFlip();			// 裏画面の内容を表画面に反映
		dNextTime += 16.66;
		if (dNextTime > GetNowCount()) {
			WaitTimer((int)dNextTime - GetNowCount());
		}

	}
	/*//更新日を書き込む
	Data = { imanojikan.tm_mon + 1, imanojikan.tm_mday,imanojikan.tm_hour,imanojikan.tm_min };

	fopen_s(&fp, "time.txt", "wb");//ファイルを開く
	if (fp == NULL) {//エラーが起きたらNULLを返す
		return 0;
	}
	fwrite(&Data, sizeof(Data), 1, fp); // SaveData_t構造体の中身を出力
	fclose(fp);//ファイルを閉じる*/

	DxLib_End();	// DXライブラリ使用の終了処理

	return 0;	// ソフトの終了
}
/***********************************************
 * ゲームメイン
 ***********************************************/
void GameMain(void)
{
	BackScrool();
	DrawMap();
	EnemyMove();
	EnemyAttck();
	//BackScrool();
	PlayerMove();
	//DrawMap();
	notesjudge();
	notes();
	PlayerAttack();
	//DrawFormatString(50, 100, 0xffffff, "%d", p_y);
	//DrawFormatString(50, 150, 0xffffff, "%d", player.p_x);
	//DrawBox(39 * player.p_x, 39 * p_y, 39 * player.p_x + 39, 39 * p_y + 39, 0xffffff, TRUE); //プレイヤーのbox
	//4810 4860 7380 7420
	if (g_KeyFlg & PAD_INPUT_3 && player.px > 7380 && player.px < 7420) {
		g_stage = 1;	//マップチップ
		StopSoundMem(rockBGM);
		PlayerInit();
		ScroolInit();

		//ノーツの初期化
		for (int i = 0; i < 100; i++) {
			notesinit(i);
		}
		g_GameState = 4;
	}
}

void FpsTimeFanction() {
	if (FpsTime_i == 0)
		FpsTime[0] = GetNowCount();               //1周目の時間取得
	if (FpsTime_i == 49) {
		FpsTime[1] = GetNowCount();               //50周目の時間取得
		Fps = 1000.0f / ((FpsTime[1] - FpsTime[0]) / 50.0f);//測定した値からfpsを計算
		FpsTime_i = 0;//カウントを初期化
	}
	else
		FpsTime_i++;//現在何周目かカウント
	if (Fps != 0)
		SetFontSize(32);
		DrawFormatString(565, 460, 0x000000, "FPS %.1f", Fps); //fpsを表示
	return;
}
